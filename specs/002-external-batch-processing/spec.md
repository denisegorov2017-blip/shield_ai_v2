# Спецификация функции: Обработка внешних партий

**Функциональная ветка**: `002-external-batch-processing`
**Создано**: 2025-11-13
**Статус**: В процессе
**Входные данные**: Описание пользователя: "Обрабатывает “внешние” партии вне периода отчёта: если при расходе по FIFO нет партии с датой поступления, создаётся и визуально выделяется “external”-batch. Маркируется external=True, тип документа — 'external', c пояснением. Дополнительно внедрить подробный лог, уведомление в итоговом отчёте, а также визуальное выделение таких партий в Markdown/JSON."

## Пользовательские сценарии и тестирование *(обязательно)*

### Пользовательская история 1 - Создание внешней партии при расходе (Приоритет: P1)

При обработке расходного документа, если система не находит существующую партию для списания товара по принципу FIFO, должна быть автоматически создана "внешняя" партия. Эта партия должна быть помечена как `external=True` и содержать документ типа `'external'` с пояснением о том, что она создана автоматически, так как поступление произошло вне периода отчета.

**Почему этот приоритет**: Это основной функционал, решающий проблему учета товаров, поступивших вне периода отчета, и обеспечивающий корректность FIFO-списаний.

**Независимый тест**: Можно протестировать, подав на вход данные с расходным документом, для которого нет соответствующей приходной партии в рамках отчетного периода, и убедиться, что создается новая "внешняя" партия.

**Сценарии приемки**:

1.  **Дано** в системе есть товар, **Когда** обрабатывается расходный документ, для которого нет достаточной приходной партии по FIFO, **Тогда** создается новая партия с `external=True` и соответствующим документом `type: 'external'`.
2.  **Дано** создана "внешняя" партия, **Когда** проверяется ее структура, **Тогда** она содержит `batch_code` вида `external-ГГГГ-ММ-ДД ЧЧ:ММ:СС`, `qty` отражает списание, и в `documents` есть запись `type: 'external'` с пояснением.

______________________________________________________________________

### Граничные случаи

-   Что происходит, когда дата расходного документа сильно раньше или сильно позже всех существующих партий? (Должна быть создана "внешняя" партия с датой, максимально близкой к дате расхода, или датой из документа)
-   Как система обрабатывает ситуацию, когда для "внешней" партии не удается извлечь дату из названия документа? (Должна использоваться текущая дата, как fallback)

## Требования *(обязательно)*

### Функциональные требования

-   **FR-001**: Система ДОЛЖНА автоматически создавать "внешнюю" партию (`external=True`) при отсутствии достаточных остатков для FIFO-списания.
-   **FR-002**: Созданная "внешняя" партия ДОЛЖНА иметь тип документа `'external'` и пояснение о ее автоматическом создании.
-   **FR-003**: Система ДОЛЖНА извлекать дату для "внешней" партии из названия расходного документа, если это возможно, в противном случае использовать текущую дату.
-   **FR-004**: Система ДОЛЖНА добавлять подробное логирование процесса создания и использования "внешних" партий.
-   **FR-005**: Система ДОЛЖНА включать уведомление о создании "внешних" партий в итоговый отчет.
-   **FR-006**: Система ДОЛЖНА визуально выделять "внешние" партии в Markdown-отчетах и JSON-выводе.

### Ключевые сущности *(включить, если функция включает данные)*

-   **Партия**: Представляет собой группу товаров, поступивших в определенное время. Ключевой атрибут `external` (boolean) для обозначения внешней партии.
-   **Документ**: Запись о движении товара. Ключевой атрибут `doc_type` может быть `'external'` для внешних партий.

## Критерии успеха *(обязательно)*

### Измеримые результаты

-   **SC-001**: 100% расходных документов, для которых не найдено партий по FIFO, приводят к корректному созданию "внешних" партий.
-   **SC-002**: Все созданные "внешние" партии корректно помечаются `external=True` и содержат соответствующий документ `type: 'external'`.
-   **SC-003**: Логирование процесса создания "внешних" партий обеспечивает полную отслеживаемость их возникновения.
-   **SC-004**: Итоговый отчет содержит четкие уведомления о наличии "внешних" партий.
-   **SC-005**: "Внешние" партии в Markdown-отчетах и JSON-выводе легко идентифицируются благодаря визуальному выделению.
