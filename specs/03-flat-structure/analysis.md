# Анализ кодовой базы для рефакторинга shield_ai_v2

**Ветка**: `03-flat-structure` | **Дата**: 2025-11-14 | **Спецификация**: [specs/03-flat-structure/spec.md](specs/03-flat-structure/spec.md:1)

## 1. Обзор

Этот документ представляет собой анализ текущей кодовой базы проекта shield_ai_v2 с целью выявления проблем и обоснования необходимости рефакторинга в сторону flat-структуры. Анализ основан на ключевых файлах, отвечающих за парсинг, бизнес-логику и UI.

## 2. Анализ ключевых компонентов

### 2.1. `src/shield_ai/infrastructure/parsers/inventory_parser.py`

- **Сложность**: Файл содержит более 1100 строк кода, что делает его сложным для понимания и поддержки.
- **Логика FIFO**: Метод `_apply_fifo_expense` реализует сложную логику FIFO, которая является основным источником сложности.
- **Классификация строк**: Метод `_classify_row` использует хрупкую и трудно поддерживаемую логику для определения типа строки.
- **Управление состоянием**: Парсер управляет сложным состоянием через `context`, что затрудняет отладку.
- **Двухпроходный подход**: Первый проход собирает информацию, второй — применяет FIFO, что усложняет логику.
- **Специальные случаи**: Множество специальных обработок для разных типов документов (например, "Пересортица").

### 2.2. `src/shield_ai/domain/entities/batch.py`

- **Класс `Batch`**: Представляет партию товара, но сильно связан с базой данных (поля `id`, `product_id`).
- **Валидация**: `__post_init__` содержит валидацию, что является хорошей практикой, но класс в целом не является чистой доменной сущностью.
- **Связанность**: Тесная связь с БД нарушает принципы чистой архитектуры.

### 2.3. `src/shield_ai/application/use_cases/calibrate_coefficients.py`

- **Use Case `CalibrateCoefficientsUseCase`**: Реализует сложную бизнес-логику калибровки коэффициентов.
- **Взаимодействие с БД**: Use case напрямую работает с SQLAlchemy, что нарушает инверсию зависимостей.
- **Тяжелые зависимости**: Использование `scipy.optimize.minimize` усложняет и утяжеляет проект.

### 2.4. `src/shield_ai/presentation/ui/pages/1_parse.py`

- **Streamlit UI**: Определяет UI для парсинга Excel-файлов.
- **Смешение логики**: UI-логика смешана с логикой парсинга, что затрудняет поддержку.
- **Два типа парсеров**: Наличие двух типов парсеров ("Стандартный" и "Парсер остатков") указывает на избыточную сложность.

## 3. Выявленные проблемы

1.  **Высокая сложность**: Текущая реализация парсера и логики FIFO слишком сложна и трудно поддерживаема.
2.  **Сильная связанность**: Компоненты разных слоев сильно связаны друг с другом, что нарушает принципы чистой архитектуры.
3.  **Низкая тестируемость**: Из-за высокой связанности и сложности, компоненты трудно тестировать в изоляции.
4.  **Смешение ответственности**: UI, бизнес-логика и детали реализации смешаны в одних и тех же файлах.
5.  **Избыточные абстракции**: Существующие классы и методы слишком сложны для решаемых задач.

## 4. Рекомендации по рефакторингу

1.  **Упростить парсер**: Заменить сложную логику на простое flat-преобразование Excel-файла в DataFrame.
2.  **Разделить слои**:
    -   **Domain**: Только dataclasses и чистая бизнес-логика.
    -   **Application**: Use cases, работающие с репозиториями.
    -   **Infrastructure**: Реализация репозиториев, парсеров и работы с БД.
    -   **Presentation**: Только UI-логика.
3.  **Внедрить dataclasses**: Использовать простые dataclasses для доменных сущностей.
4.  **Упростить use cases**: Упростить логику калибровки и вынести тяжелые зависимости.
5.  **Унифицировать парсинг**: Создать единый, простой и эффективный механизм парсинга.

## 5. Заключение

Анализ подтверждает, что рефакторинг в сторону flat-структуры необходим для упрощения проекта, повышения его производительности, тестируемости и поддерживаемости. Предложенные изменения позволят создать более гибкую и масштабируемую архитектуру, готовую к дальнейшему развитию.