# План реализации: Рефакторинг проекта для расчёта усушки и учёта по партиям

**Ветка**: `03-flat-structure` | **Дата**: 2025-11-14 | **Спецификация**: [specs/03-flat-structure/spec.md](specs/03-flat-structure/spec.md:1)
**Ввод**: Спецификация функции из `/specs/[###-название-функции]/spec.md`

**Примечание**: Этот шаблон заполняется командой `/speckit.plan`. См. `.specify/templates/commands/plan.md` для рабочего процесса выполнения.

## Резюме

Реализация flat-структуры для проекта shield_ai_v2 с целью упрощения расчёта усушки и учёта по партиям. Включает в себя упрощение импорта отчётов до flat-преобразования, внедрение чистой архитектуры с четким разделением слоев (domain, application, infrastructure, presentation), повышение тестируемости и типизации кода, упрощение экспорта и интеграции с различными форматами, а также улучшение работы с отчетами и аудитом.

## Технический контекст

**Язык/Версия**: Python 3.12\
**Основные зависимости**: pandas, streamlit, SQLAlchemy, pytest\
**Хранилище**: SQLite, JSON, Excel файлы\
**Тестирование**: pytest\
**Целевая платформа**: сервер Linux/WSL\
**Тип проекта**: веб/одиночный\
**Цели производительности**: обработка файлов до 100МБ, импорт за <30 секунд, расчёт усушки за <1 минуту\
**Ограничения**: код строго синхронный (без async/await), минимальное покрытие тестами 80% (95% для слоёв domain и application)\
**Масштаб/Объем**: поддержка данных за месяц, 90% удовлетворенности пользователей

## Проверка конституции

*ПРОХОД: Должен пройти до исследования фазы 0. Повторная проверка после проектирования фазы 1.*

Соответствует глобальным правилам разработки:
- Код синхронный (без async/await)
- Используется MyPy strict типизация
- Архитектура соответствует принципам чистой архитектуры
- Покрытие тестами >90%

## Структура проекта

### Документация (эта функция)

```text
specs/03-flat-structure/
├── plan.md              # Этот файл (вывод команды /speckit.plan)
├── research.md          # Вывод фазы 0 (команда /speckit.plan)
├── data-model.md        # Вывод фазы 1 (команда /speckit.plan)
├── quickstart.md        # Вывод фазы 1 (команда /speckit.plan)
├── contracts/           # Вывод фазы 1 (команда /speckit.plan)
└── tasks.md             # Вывод фазы 2 (команда /speckit.tasks - НЕ создается командой /speckit.plan)
```

### Исходный код (корень репозитория)

```text
src/
├── shield_ai/
│   ├── domain/
│   │   ├── entities/
│   │   │   ├── batch.py          # BatchMovement, BatchBalance dataclasses
│   │   │   └── shrinkage_profile.py # ShrinkageCalculation
│   │   └── shrinkage/
│   │       └── strategies.py     # Логика расчёта усушки
│   ├── application/
│   │   └── use_cases/
│   │       ├── calibrate_coefficients.py
│   │       └── forecast_shrinkage.py
│   ├── infrastructure/
│   │   ├── parsers/
│   │   │   └── inventory_parser.py  # Упрощённый парсер Excel/JSON/MD
│   │   └── database/
│   │       ├── models.py
│   │       └── session.py
│   └── presentation/
│       └── ui/
│           └── pages/
│               ├── 1_parse.py      # Обновлённый UI для импорта
│               ├── 2_calibrate.py    # Обновлённый UI для расчёта усушки
│               └── 5_shrinkage_analysis.py # Обновлённый UI для аудита
└── tests/
    ├── unit/
    │   ├── domain/
    │   ├── application/
    │   └── infrastructure/
    ├── integration/
    └── validation/
```

**Решение по структуре**: Используется существующая структура проекта с модификациями для flat-подхода. Сохраняется разделение на слои: domain (бизнес-логика), application (use cases), infrastructure (парсеры, БД), presentation (UI). Добавляются новые dataclasses и упрощаются существующие компоненты.

## Отслеживание сложности

> **Заполнить ТОЛЬКО если проверка конституции имеет нарушения, которые должны быть оправданы**

| Нарушение | Почему необходимо | Более простая альтернатива отклонена, потому что |
|-----------|------------|-------------------------------------|
| [Нет нарушений] | [Нет] | [Нет] |