# Модель данных: Рефакторинг проекта для расчёта усушки и учёта по партиям

**Ветка**: `03-flat-structure` | **Дата**: 2025-11-14 | **Спецификация**: [specs/03-flat-structure/spec.md](specs/03-flat-structure/spec.md:1)

## Обзор модели данных

В рамках рефакторинга проекта shield_ai_v2 для упрощения расчёта усушки и учёта по партиям, вводится flat-структура данных с минимальной иерархией и сложностью. Модель данных основана на простых сущностях, представленных в виде dataclasses, с чётко определёнными полями и типами.

## Сущности доменного слоя

### BatchMovement (движение по партии)

Представляет собой движение товара по конкретной партии на определённую дату.

```python
from dataclasses import dataclass
from datetime import date
from typing import Optional

@dataclass
class BatchMovement:
    """Движение товара по партии"""
    nomenclature: str              # Номенклатура
    date: date                     # Дата
    movement_type: str             # Тип движения (приход/расход/корректировка и т.д.)
    quantity: float                # Количество
    warehouse: str                 # Склад
```

### BatchBalance (остаток по партии)

Представляет собой остаток товара по конкретной партии на определённую дату.

```python
@dataclass
class BatchBalance:
    """Остаток товара по партии"""
    nomenclature: str              # Номенклатура
    date: date                     # Дата
    balance: float                 # Остаток
    warehouse: str                 # Склад
    batch: str                     # Партия
```

### ShrinkageCalculation (расчёт усушки)

Представляет собой результат расчёта усушки по номенклатуре за определённый период.

```python
@dataclass
class ShrinkageCalculation:
    """Результат расчёта усушки"""
    product_name: str              # Название номенклатуры
    calculation_period_start: date # Начало периода расчёта
    calculation_period_end: date   # Конец периода расчёта
    initial_balance: float         # Начальный остаток
    movements_total: float         # Всего движений (приход/расход)
    final_balance: float           # Конечный остаток по факту
    calculated_shrinkage: float    # Рассчитанная усушка по норме
    actual_shrinkage: float        # Фактическая убыль (разница между ожидаемым и реальным остатком)
    shrinkage_percentage: float    # Процент усушки
    variance: float                # Отклонение (факт - норма)
```

## Связи между сущностями

- **BatchMovement** → **BatchBalance**: Движения используются для расчёта остатков
- **BatchMovement** + **BatchBalance** → **ShrinkageCalculation**: Движения и остатки используются для расчёта усушки
- **BatchBalance** → **BatchBalance**: Остатки разных дат могут быть сопоставлены для анализа

## Атрибуты и ограничения

### BatchMovement
- `nomenclature`: обязательное поле, строка, идентифицирует номенклатуру
- `date`: обязательное поле, дата, когда произошло движение
- `movement_type`: обязательное поле, строка, тип движения (например, "Приход", "Расход", "Корректировка")
- `quantity`: обязательное поле, число, количество товара (может быть положительным или отрицательным)
- `warehouse`: обязательное поле, строка, идентификатор склада

### BatchBalance
- `nomenclature`: обязательное поле, строка, идентифицирует номенклатуру
- `date`: обязательное поле, дата, на которую показан остаток
- `balance`: обязательное поле, число, количество товара на остатке (неотрицательное)
- `warehouse`: обязательное поле, строка, идентификатор склада
- `batch`: обязательное поле, строка, идентифицирует партию

### ShrinkageCalculation
- `product_name`: обязательное поле, строка, идентифицирует номенклатуру
- `calculation_period_start`: обязательное поле, дата начала периода расчёта
- `calculation_period_end`: обязательное поле, дата окончания периода расчёта
- `initial_balance`: обязательное поле, начальный остаток в периоде
- `movements_total`: обязательное поле, сумма всех движений в периоде
- `final_balance`: обязательное поле, фактический остаток в конце периода
- `calculated_shrinkage`: обязательное поле, нормативная усушка
- `actual_shrinkage`: обязательное поле, фактическая убыль
- `shrinkage_percentage`: обязательное поле, процент усушки
- `variance`: обязательное поле, отклонение факта от нормы

## Типы данных

- **Строки**: Все текстовые поля (product_name, batch_number, movement_type, warehouse, document_type, document_number, unit)
- **Числа с плавающей точкой**: Количество (quantity), остатки (balance), расчёты усушки
- **Даты**: Все поля дат (movement_date, balance_date, calculation_period_start, calculation_period_end)
- **Опциональные поля**: Поля, которые могут отсутствовать в некоторых источниках данных

## Плоская таблица (Flat Table) для анализа

Для упрощения анализа и расчётов, все данные могут быть представлены в виде плоской таблицы pandas с полями:

| Поле | Тип | Описание |
|------|-----|----------|
| product_name | string | Название номенклатуры |
| batch_number | string | Номер партии |
| date | datetime | Дата события (движение или остаток) |
| event_type | string | Тип события ('movement' или 'balance') |
| movement_type | string | Тип движения (если event_type='movement') |
| balance_type | string | Тип остатка (если event_type='balance') |
| quantity | float64 | Количество (движение или остаток) |
| warehouse | string | Склад |
| unit | string | Единица измерения |
| document_type | string | Тип документа (если применимо) |
| document_number | string | Номер документа (если применимо) |

## Преимущества flat-структуры

1. **Простота**: Упрощённая структура данных, легко понимаемая и обрабатываемая
2. **Гибкость**: Возможность лёгкого добавления новых полей без изменения архитектуры
3. **Производительность**: Быстрая обработка с помощью pandas и других библиотек
4. **Тестируемость**: Простые сущности легко тестировать юнит-тестами
5. **Интеграция**: Упрощённый экспорт и импорт данных в различные форматы

## Соответствие пользовательским сценариям

- **История 1 (упрощённый импорт)**: Dataclasses позволяют легко конвертировать Excel-данные в структурированный формат
- **История 2 (расчёт усушки)**: ShrinkageCalculation предоставляет готовую структуру для результатов расчёта
- **История 3 (аудит остатков)**: BatchBalance позволяет легко выявлять отрицательные остатки
- **История 4 (экспорт)**: Простые структуры легко сериализуются в JSON, Markdown и другие форматы