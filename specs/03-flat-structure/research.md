# Исследование: Рефакторинг проекта для расчёта усушки и учёта по партиям

**Ветка**: `03-flat-structure` | **Дата**: 2025-11-14 | **Спецификация**: [specs/03-flat-structure/spec.md](specs/03-flat-structure/spec.md:1)

## Цель исследования

Провести техническое исследование для реализации flat-структуры в проекте shield_ai_v2 с целью упрощения расчёта усушки и учёта по партиям. Определить лучшие практики, потенциальные проблемы и оптимальные решения для упрощения архитектуры.

## Анализ текущей архитектуры

### Существующая структура проекта

Проект shield_ai_v2 уже использует архитектурный подход с разделением на слои:
- **domain**: бизнес-логика (entities, стратегии усушки)
- **application**: use cases (калибровка, прогнозирование)
- **infrastructure**: парсеры, база данных
- **presentation**: UI (Streamlit)

### Проблемы текущей архитектуры

1. **Сложность импорта данных**: Существующий парсер в [src/shield_ai/infrastructure/parsers/inventory_parser.py](src/shield_ai/infrastructure/parsers/inventory_parser.py:1) содержит сложную логику обработки FIFO, пересортицы и коррекций
2. **Избыточные абстракции**: Слишком много классов и методов для простых операций
3. **Сложность тестирования**: Из-за сложных зависимостей и связей между компонентами
4. **Недостаточная типизация**: Отсутствие строгой типизации в ключевых местах

## Технические решения

### 1. Упрощение импорта данных

**Цель**: Заменить сложную логику импорта на flat-преобразование отчёта

**Решение**: 
- Создать упрощённый парсер, который преобразует Excel-файл в плоскую таблицу (flat table)
- Удалить сложную логику FIFO и пересортицы из основного импорта
- Сохранить возможность обработки разных форматов (Excel, JSON, Markdown)

**Преимущества**:
- Упрощение кода и повышение производительности
- Легче тестировать и отлаживать
- Повышение надёжности импорта

### 2. Чистая архитектура

**Цель**: Чётко отделить слои архитектуры

**Решение**:
- **domain**: Только бизнес-сущности и логика расчёта усушки
- **application**: Use cases, координирующие работу между слоями
- **infrastructure**: Только внешние зависимости (парсеры, БД)
- **presentation**: Только UI-логика

**Преимущества**:
- Легче поддерживать и изменять отдельные компоненты
- Упрощение тестирования за счёт изоляции
- Лучшее понимание архитектуры для новых разработчиков

### 3. Повышение типизации и тестируемости

**Цель**: Обеспечить строгую типизацию и полное покрытие тестами

**Решение**:
- Использовать dataclasses для представления сущностей (BatchMovement, BatchBalance, ShrinkageCalculation)
- Применить TypedDict для представления таблиц данных
- Покрыть юнит-тестами все публичные функции и классы
- Использовать MyPy в strict режиме

**Преимущества**:
- Снижение количества багов, связанных с типами
- Лучшая поддержка IDE
- Повышенная надёжность кода

### 4. Унификация экспорта

**Цель**: Ввести единый интерфейс экспорта данных

**Решение**:
- Создать интерфейсы для экспорта в JSON, Markdown, SQLite
- Разделить логику преобразования и логику сохранения
- Обеспечить консистентность форматов между разными методами экспорта

**Преимущества**:
- Легче добавлять новые форматы экспорта
- Единая точка управления форматами
- Упрощение тестирования экспорта

## Потенциальные риски и пути их решения

### Риск 1: Потеря функциональности при упрощении

**Описание**: При упрощении сложной логики могут быть потеряны важные функции

**Решение**:
- Провести полный аудит текущей функциональности
- Оставить возможность подключения сложной логики как опциональных модулей
- Провести тестирование с реальными данными перед полным переходом

### Риск 2: Проблемы с производительностью на больших объёмах

**Описание**: Flat-подход может привести к увеличению объёма обрабатываемых данных

**Решение**:
- Использовать pandas и numpy для эффективной обработки больших объёмов
- Внедрить оптимизации при работе с большими таблицами
- Провести нагрузочное тестирование

### Риск 3: Сложность миграции существующих данных

**Описание**: Переход на новую структуру может потребовать миграции данных

**Решение**:
- Создать скрипты миграции для преобразования существующих данных
- Обеспечить обратную совместимость на время перехода
- Провести поэтапную миграцию с тестированием на каждом этапе

## Рекомендации по реализации

### Фаза 1: Подготовка и проектирование

1. Создать dataclasses для основных сущностей (BatchMovement, BatchBalance, ShrinkageCalculation)
2. Разработать упрощённый парсер Excel-файлов
3. Создать прототип логики расчёта усушки на flat-данных

### Фаза 2: Реализация и тестирование

1. Реализовать полную логику импорта в новой архитектуре
2. Покрыть юнит-тестами основные компоненты
3. Интегрировать новую логику в существующий UI

### Фаза 3: Валидация и внедрение

1. Провести сравнительное тестирование с существующей версией
2. Обеспечить плавный переход пользователей
3. Обновить документацию и примеры

## Заключение

Реализация flat-структуры для проекта shield_ai_v2 является технически целесообразной и позволит достичь целей упрощения архитектуры, повышения производительности и улучшения тестируемости. При этом важно внимательно подойти к миграции данных и обеспечить обратную совместимость на время перехода.