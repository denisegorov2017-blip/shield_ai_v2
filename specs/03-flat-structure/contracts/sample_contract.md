# Контракт на интеграцию: Расчёт усушки

**Ветка**: `03-flat-structure` | **Дата**: 2025-11-14 | **Спецификация**: [specs/03-flat-structure/spec.md](specs/03-flat-structure/spec.md:1)

## Описание контракта

Контракт определяет ожидаемое поведение и интерфейсы для модуля расчёта усушки в рамках рефакторинга проекта shield_ai_v2. Контракт служит основой для разработки, тестирования и интеграции компонентов.

## Интерфейсы

### 1. Интерфейс парсера данных

**Назначение**: Преобразование Excel-файла в плоскую таблицу данных

```python
def parse_inventory_file(file_path: str) -> pd.DataFrame:
    """
    Парсит Excel файл с данными об остатках и движениях
    
    Args:
        file_path: Путь к Excel файлу
        
    Returns:
        DataFrame с колонками: 
        - product_name (str): Название номенклатуры
        - batch_number (str): Номер партии
        - date (datetime): Дата операции
        - movement_type (str): Тип движения (приход/расход/корректировка)
        - quantity (float): Количество
        - warehouse (str): Склад
        - unit (str): Единица измерения
        
    Raises:
        ValueError: При некорректном формате файла
        FileNotFoundError: При отсутствии файла
    """
```

**Контрактное поведение**:
- Возвращает структурированные данные из Excel файла
- Обрабатывает разные форматы Excel файлов
- Валидирует данные на этапе парсинга
- Генерирует исключения при ошибках

### 2. Интерфейс расчёта усушки

```python
def calculate_shrinkage(
    movements: List[BatchMovement], 
    start_date: date, 
    end_date: date
) -> List[ShrinkageCalculation]:
    """
    Рассчитывает усушку по данным движениям
    
    Args:
        movements: Список движений по партиям
        start_date: Начало периода расчёта
        end_date: Конец периода расчёта
        
    Returns:
        Список результатов расчёта усушки
    """
```

**Контрактное поведение**:
- Принимает список движений по партиям
- Возвращает результаты расчёта усушки для каждой номенклатуры
- Учитывает нормативы усушки
- Обрабатывает крайние случаи (нулевые остатки, отрицательные значения)

### 3. Интерфейс валидации остатков

```python
def validate_balances(movements: List[BatchMovement]) -> List[Dict[str, Any]]:
    """
    Проверяет остатки на отрицательные значения и другие аномалии
    
    Args:
        movements: Список движений по партиям
        
    Returns:
        Список проблем, найденных в данных
    """
```

**Контрактное поведение**:
- Находит отрицательные остатки
- Определяет подозрительные движения
- Возвращает отчёт о проблемах в структурированном виде

## Ожидаемые результаты

### 1. Производительность

- Импорт Excel файла до 100МБ: <30 секунд
- Расчёт усушки по данным за месяц: <1 минуты
- Валидация остатков: <10 секунд

### 2. Точность

- 100% покрытие юнит-тестами для основных функций
- Ошибки расчёта: <0.01%
- Обработка крайних случаев: полная

### 3. Надёжность

- Обработка некорректных данных без падений
- Валидация входных данных
- Контроль типов с использованием MyPy strict

## Соглашения об именовании

- Функции: глагол + существительное (например, `parse_inventory_file`, `calculate_shrinkage`)
- Классы: существительное (например, `BatchMovement`, `ShrinkageCalculation`)
- Переменные: существительные в snake_case (например, `movement_date`, `product_name`)
- Константы: в верхнем регистре (например, `DEFAULT_SHELF_LIFE_DAYS`)

## Обработка ошибок

- Все функции выбрасывают исключения с понятными сообщениями
- Ошибки валидации данных: `ValueError`
- Ошибки доступа к файлам: `FileNotFoundError`, `PermissionError`
- Ошибки логики расчётов: кастомные исключения

## Совместимость

- Поддержка Python 3.12+
- Совместимость с pandas 1.5+
- Поддержка форматов Excel: .xlsx, .xls
- Экспорт в форматы: JSON, Markdown, SQLite

## Тестирование

Каждый интерфейс должен быть покрыт:
- Юнит-тестами (проверка логики)
- Интеграционными тестами (проверка взаимодействия компонентов)
- Тестами производительности (проверка соответствия требованиям)