# Спецификация функции: Рефакторинг проекта для расчёта усушки и учёта по партиям

**Функциональная ветка**: `03-flat-structure`\
**Создано**: 2025-11-14\
**Статус**: Черновик\
**Входные данные**: Описание пользователя: "План рефакторинга проекта shield_ai_v2 для расчёта усушки и учёта по партиям"

## Пользовательские сценарии и тестирование *(обязательно)*

### Пользовательская история 1 - Упрощённый импорт отчётов (Приоритет: P1)

Пользователь хочет импортировать Excel-отчёты с данными о движении товаров и остатках на складах. Вместо сложного процесса с FIFO и пересортицей, он хочет получить простое преобразование отчёта в плоскую таблицу (flat table) с минимальной обработкой.

**Почему этот приоритет**: Это основа всей системы - без простого импорта невозможно провести расчёты усушки. Это критическая функция, на которой строится вся остальная логика.

**Независимый тест**: Можно полностью протестировать с помощью загрузки Excel-файла и получения плоской таблицы данных - предоставляет базовую функциональность для всех последующих операций.

**Сценарии приемки**:

1. **Дано** пользователь имеет Excel-файл с отчётом по остаткам и движениям, **Когда** он загружает файл в систему, **Тогда** система возвращает плоскую таблицу с основными полями (номенклатура, партия, дата, остаток, склад и т.д.)
1. **Дано** пользователь загружает отчёт с нестандартной структурой, **Когда** система пытается обработать файл, **Тогда** система либо преобразует его в стандартную структуру, либо возвращает понятную ошибку

______________________________________________________________________

### Пользовательская история 2 - Расчёт усушки по упрощённой логике (Приоритет: P1)

Пользователь хочет рассчитать усушку (естественную убыль) по товарным позициям, используя упрощённую логику без сложных FIFO-расчётов. Он ожидает получить отчёт с расчётами усушки и отклонениями.

**Почему этот приоритет**: Это основная бизнес-ценность системы - расчёт усушки. После упрощения импорта это второй критический шаг.

**Независимый тест**: Можно протестировать с плоской таблицей данных - ввод данных и получение отчёта по усушке без сложных внутренних процессов.

**Сценарии приемки**:

1. **Дано** плоская таблица с данными по остаткам и движениям, **Когда** пользователь запускает расчёт усушки, **Тогда** система возвращает отчёт с расчётами усушки по номенклатуре
1. **Дано** данные содержат отрицательные остатки, **Когда** система проводит расчёт, **Тогда** система выделяет такие случаи в отдельный отчёт для аудита

______________________________________________________________________

### Пользовательская история 3 - Аудит и проверка остатков (Приоритет: P2)

Пользователь хочет проверить корректность остатков, выявить отрицательные остатки и излишки, получить отчёты для анализа. Это должно быть реализовано через простые SQL-запросы или pandas-операции без сложных классовых структур.

**Почему этот приоритет**: После расчёта усушки важно проверить данные на ошибки и аномалии. Это обеспечивает надёжность системы.

**Независимый тест**: Можно протестировать отдельно на готовой плоской таблице - проверка остатков не зависит от процесса импорта или расчёта усушки.

**Сценарии приемки**:

1. **Дано** плоская таблица с данными, **Когда** пользователь запускает аудит остатков, **Тогда** система выдаёт отчёт с отрицательными остатками
1. **Дано** данные содержат подозрительные движения, **Когда** система анализирует их, **Тогда** система выделяет их в отдельный отчёт для проверки

______________________________________________________________________

### Пользовательская история 4 - Экспорт и отчёты в разных форматах (Приоритет: P3)

Пользователь хочет экспортировать результаты расчётов в разные форматы (JSON, Markdown, SQLite) для дальнейшего использования или интеграции с другими системами.

**Почему этот приоритет**: Это завершающий этап работы с системой - возможность использовать результаты в других системах или для отчётов.

**Независимый тест**: Можно протестировать отдельно на готовом результате расчёта - экспорт не зависит от процесса расчёта, только от его результата.

**Сценарии приемки**:

1. **Дано** результаты расчёта усушки в памяти, **Когда** пользователь выбирает экспорт в JSON, **Тогда** система создаёт корректный JSON-файл с результатами
1. **Дано** результаты расчёта готовы, **Когда** пользователь выбирает экспорт в Markdown, **Тогда** система создаёт читаемый отчёт в формате Markdown

______________________________________________________________________

### Граничные случаи

- Система ДОЛЖНА выдавать ошибку и останавливать импорт при обнаружении дублирующихся записей или некорректных дат.
- Система ДОЛЖНА выдавать ошибку и останавливать импорт при обнаружении отсутствующих или нулевых значений в критических полях.
- Система ДОЛЖНА выполнять расчёт усушки на очень больших объёмах данных, но с предупреждением о возможном снижении производительности.

## Требования *(обязательно)*

## Clarifications
### Session 2025-11-15
- Q: Какие конкретные типы данных (например, строки, числа, даты) ожидаются для полей "номенклатура", "партия", "дата", "остаток", "склад" в плоской таблице, получаемой после импорта Excel-отчётов? → A: Поля "остаток" и "количество" должны быть числами, "дата" - датой, остальные - строками

## Clarifications
### Session 2025-11-15
- Q: Какие меры безопасности и конфиденциальности данных должны быть реализованы для защиты импортируемых и обрабатываемых данных? → A: Аудит доступа к данным и изменений

## Clarifications
### Session 2025-11-15
- Q: Какие конкретные метрики должны быть реализованы для мониторинга производительности и стабильности системы? → A: Все вышеперечисленные

## Clarifications
### Session 2025-11-15
- Q: Как система должна обеспечивать логирование и метрики для наблюдаемости (Observability)? → A: Интегрировать стороннюю библиотеку для логирования (например, Loguru).

## Clarifications
### Session 2025-11-15
- Q: Как система должна обрабатывать попытки рассчитать усушку на очень больших объёмах данных (например, более 100МБ)? → A: Выполнять расчёт, но с предупреждением о возможном снижении производительности

## Clarifications
### Session 2025-11-15
- Q: Как система должна обрабатывать отсутствующие или нулевые значения в критических полях при импорте данных? → A: Выдавать ошибку и останавливать импорт при обнаружении отсутствующих или нулевых значений в критических полях

## Clarifications
### Session 2025-11-15
- Q: Как система должна обрабатывать дублирующиеся записи или некорректные даты в импортируемых отчётах? → A: Выдавать ошибку и останавливать импорт при обнаружении дубликатов или некорректных дат

## Clarifications
### Session 2025-11-15
- Q: Какие конкретные "сложные алгоритмы FIFO и пересортицы" должны быть исключены из первоначальной реализации импорта Excel-отчётов? → A: Алгоритмы FIFO для определения стоимости запасов, алгоритмы пересортицы для оптимизации складских операций

### Функциональные требования

- **FR-001**: Система ДОЛЖНА преобразовывать Excel-отчёты в плоскую таблицу, исключая сложные алгоритмы FIFO для определения стоимости запасов и алгоритмы пересортицы для оптимизации складских операций.
- **FR-002**: Система ДОЛЖНА вычислять усушку по упрощённой логике на основе плоской таблицы данных
- **FR-003**: Система ДОЛЖНА проверять остатки на отрицательные значения и выделять их в отдельный отчёт
- **FR-004**: Система ДОЛЖНА обеспечивать экспорт результатов в форматы JSON, Markdown и SQLite
- **FR-005**: Система ДОЛЖНА покрывать код типизацией (MyPy strict) и юнит-тестами в соответствии с конституцией: минимум 80% общего покрытия и 95% покрытия для слоёв domain и application
- **FR-011**: Система ДОЛЖНА разделять архитектуру на слои: domain, application, infrastructure, presentation
- **FR-007**: Система ДОЛЖНА использовать dataclasses и TypedDict для структурирования данных
- **FR-008**: Система ДОЛЖНА обеспечивать плоскую, легко тестируемую структуру без глубоких классовых связей
- **FR-009**: Система ДОЛЖНА обеспечивать быстрый импорт, расчёт и экспорт без задержек
- **FR-010**: Система ДОЛЖНА включать функции аудита минусовых остатков и излишков

### Ключевые сущности *(включить, если функция включает данные)*
- **BatchMovement**: Представляет движение товара по партии с полями: номенклатура (строка), дата (дата), тип_движения (строка), количество (число), склад (строка)
- **BatchBalance**: Представляет остаток товара по партии с полями: номенклатура (строка), дата (дата), остаток (число), склад (строка), партия (строка)
- **ShrinkageCalculation**: Результат расчёта усушки с полями: номенклатура (строка), рассчитанная_усушка (число), фактический_остаток (число), отклонение (число)

- **BatchMovement**: Представляет движение товара по партии с полями: номенклатура, дата, тип_движения, количество, склад
- **BatchBalance**: Представляет остаток товара по партии с полями: номенклатура, дата, остаток, склад, партия
- **ShrinkageCalculation**: Результат расчёта усушки с полями: номенклатура, рассчитанная_усушка, фактический_остаток, отклонение

### Нефункциональные требования
- **NFR-001**: Система ДОЛЖНА интегрировать стороннюю библиотеку для логирования (например, Loguru) для обеспечения наблюдаемости.

## Критерии успеха *(обязательно)*

### Нефункциональные требования
- **NFR-002**: Система ДОЛЖНА собирать метрики по времени импорта Excel-отчётов.
- **NFR-003**: Система ДОЛЖНА собирать метрики по времени расчёта усушки.
- **NFR-004**: Система ДОЛЖНА собирать метрики по количеству обработанных записей.

### Нефункциональные требования
- **NFR-005**: Система ДОЛЖНА обеспечивать аудит доступа к данным и изменений.

### Измеримые результаты

- **SC-001**: Пользователи могут импортировать Excel-отчёт и получить плоскую таблицу данных за менее чем 30 секунд
- **SC-002**: Система рассчитывает усушку по данным за месяц менее чем за 1 минуту
- **SC-003**: Покрытие юнит-тестами для функций расчёта усушки (слои domain и application) составляет не менее 95%
- **SC-004**: Пользователи могут выполнить полный цикл: импорт → расчёт → экспорт → аудит за менее чем 5 минут
- **SC-005**: Не менее 95% пользователей успешно завершают основной сценарий (импорт → расчёт → экспорт) без ошибок
- **SC-006**: Система обрабатывает файлы объёмом до 100МБ без сбоев
- **SC-007**: Пользователи могут запустить систему и выполнить базовый расчёт за 5 минут после установки