н# Чек-лист требований: Преобразование иерархических Excel-отчётов в плоские данные

## Общие требования к качеству контента
- [x] Требования сфокусированы на бизнес-ценности и понятны нетехническим стейкхолдерам.
- [x] Требования не содержат деталей реализации.
- [x] Все обязательные секции требований заполнены.

## Полнота требований
- [x] Все маркеры [NEEDS CLARIFICATION] удалены, требования однозначны.
- [x] Требования тестируемы и однозначны, исключают двойные толкования.
- [x] Критерии успеха измеримы и конкретны.
- [x] Критерии успеха независимы от конкретных технологий.
- [x] Определены все сценарии приемки, включая позитивные и негативные.
- [x] Идентифицированы и описаны все граничные случаи.
- [x] Четко определены границы области применения решения.
- [x] Идентифицированы все зависимости и допущения.

## Готовность функции
- [x] Для всех функциональных требований определены четкие критерии приемки.
- [x] Охвачены основные пользовательские сценарии.
- [x] Соответствие измеримым результатам.
- [x] Отсутствие утечки деталей реализации в спецификацию.

## Детальные требования на основе анализа Excel-файлов

### 1. Итоги анализа и общие особенности
- [x] **Многоразличные структуры:** Волнообразная смена иерархии (склад, номенклатура, партия, документ движения, часто без строгого шаблона строк).
- [x] **Весовые товары и рыба:** Высокоточные значения, отдельные шаблоны оформления остатков и движений (размер партии — дробный).
- [x] **Коррекции, возвраты, инвентаризации:** Могут быть отрицательные/нулевые значения, строки без явных партии/номенклатуры.
- [x] **Дублирующиеся заголовки и разрывы данных:** Нужно игнорировать повторные/разделительные строки, уметь тянуть контекст "вниз".
- [x] **Смешанные типы строк и колонок:** Перемешаны названия, даты, коды партий, пустые значения — требуется строгий парсинг по паттернам.

### Ключевые особенности структуры (для всех разобранных файлов):
- [x] Под номенклатурой (товаром) действительно идут блоки документов, а внутри документа — строки движения партии.
- [x] Каждая строка движения содержит сведения о списании или поступлении по определённой партии.
- [x] **Партия создаётся только приходным документом.** Партия — это уникальное сочетание товара и даты (времени) ее приёмки, иногда с номером или внутренним идентификатором. Если `batch_code` пропущен, он должен быть явно восстановлен по контексту из последнего валидного.
- [x] Все последующие операции (расходы, корректировки, возвраты) только "тратят" или "корректируют" уже созданную ранее партию.
- [x] Вся логика FIFO производится 1С, и ваш парсер не должен по-своему рассчитывать/размещать движения внутри партий: строки идут РОВНО в порядке, в котором возвращены в выгрузке отчёта, с сохранением всех `batch_code`/`batch_date`/`doc_type`.

### 2. Технические требования к парсеру
- [x] Автоматически отличать строки с заголовками, складом, номенклатурой, партией, движением, технические и пустые.
- [x] Для каждой строки движения чётко восстанавливать контекст: склад, товар, партия, дата, движение, количество, корректный остаток — даже при наличии пропусков и дублей.
- [x] Сохранять точность чисел (до 3 и более знаков), уметь конвертировать локали и форматы дат.
- [x] Экспортировать в единый flat-формат с полями: Склад, Номенклатура/Товар, Партия, Дата, Документ, Тип движения, Количество, Остаток, Единица, Признак веса/рыбы — для любых файлов.
- [x] Поддерживать специфику рыбы, воды, обычного товара, универсального склада.
- [x] Валидировать каждый выходной flat-словарь: ни один `batch_code`/партия не должны быть пусты при движении, все колонки строго типизированы.
- [x] Генерировать подробный лог ошибок/аномалий для аудита.
- [x] Парсеру нужен единый движок на паттернах.
- [x] Реализовать `context-tunneling`: запоминание и перенос контекста вниз для любой строки.
- [x] Поддерживать все найденные edge-cases (многократные пустые строки, неявные партии, отрицательные корректировки и т.п.).
- [x] Гарантировать, что вся выгрузка с любого из этих файлов — корректно конвертируется "в один слой".

### Итоговые требования к парсеру/спецификации:
1.  **Контекст:**
    *   [x] Всегда "тянуть" вниз актуальный контекст товара, документа, партии (дата и номер приема).
    *   [x] Если какая-либо из сущностей пропущена в строке движения, брать её из предыдущего блока, либо логировать как ошибку и пропускать строку, если восстановление невозможно.
2.  **Flat-структура строки:**
    *   [x] Каждая строка движения (output-flat) содержит: `warehouse`, `group`, `product`, `batch_code`, `batch_date`, `doc_type`, `doc_date`, `qty_begin`, `qty_in`, `qty_out`, `qty_end`, `unit`, `comment`.
    *   [x] `batch_code` & `batch_date` тянутся только от прихода (создания партии), расход — только списывает из существующей партии FIFO, все движения (в т.ч. возвраты/коррекции) указывают на уже существующую партию в отчёте.
3.  **Признаки, шаблоны, автоматическое определение:**
    *   [x] Парсер обязан использовать паттерны для отделения заголовков, итогов, разделительных строк.
    *   [x] Проверять разные шаблоны дат (с/без времени).
    *   [x] Автоматически определять специфику структуры (рыба, весовые, вода, "разливное"), если структура отличается от базовой, — по фильтрам, названиям, уникальным словам.
4.  **Не делать никакую вторичную логику партий, FIFO, агрегацию остатков — только flat-конвертация!**
    *   [x] Если последовательность движения в отчёте порвана или `batch_code`/`dates` неочевидны, оставлять строку с `error flag/log`.
5.  **Обработка ошибок и edge-case:**
    *   [x] Отдельно логировать:
        *   [x] Строки с пропущенным `batch_code`/`batch_date`, которые не удалось восстановить
        *   [x] Все некорректные структуры (двойной заголовок, строка "итого", строки с разрывом контекста)
        *   [x] Строки, в которых нарушен expected порядок (например, расход/коррекция идет до первого прихода партии)
6.  **Юнит-тесты и приёмка:**
    *   [x] Прописать сценарии — в каждом файл-отчёте после плоского конверта в тестах не должно останавливаться ни одной строки движения с пустым `batch_code` из-за пропуска контекста.
    *   [x] Должны быть тесты с двойным/разорванным документом одного товара (см. коррекции, возвраты, технические партии).

### 3. Структура столбцов и типы данных
- [x] **Столбец A**: Система должна корректно обрабатывать смешанные типы данных, объединяющие уровни иерархии (Склад, Номенклатура, Документ, Партия).
- [x] **Столбцы B, D**: Система должна игнорировать пустые вспомогательные столбцы.
- [x] **Столбец C**: Система должна обрабатывать смешанные типы данных (параметры отчета, фильтры, даты).
- [x] **Столбцы E, F, G, H**: Система должна обрабатывать числовые данные (начальный остаток, приход, расход) с высокой точностью (до 3-4 знаков после запятой).
- [x] **Даты**: Система должна корректно парсить и нормализовать даты в формате `DD.MM.YYYY HH:MM:SS`, представленные строками.
- [x] **Числа**: Система должна обрабатывать числа с плавающей точкой, сохраняя высокую точность (до 3-4 знаков после запятой).
- [x] **Сохранение точности чисел:** Парсер должен сохранять точность чисел до 3 и более знаков после запятой, уметь конвертировать локали и форматы дат.

### 4. Граничные случаи и исключения
- [x] **Пустые строки/ячейки**:
    - [x] Система должна игнорировать пустые строки в начале файла (1-3, 6-7) и строки-разделители в середине данных.
    - [x] Система должна обрабатывать ячейки с нулевыми значениями, которые могут быть как пустыми, так и содержать '0'.
    - [x] Система должна корректно обрабатывать колонки B, C, D, F, содержащие `null` значения.
- [x] **Смешанные типы в столбце A**: Система должна определять тип записи по контексту (наличие даты, структура названия, позиция в иерархии).
- [x] **Дублирующиеся заголовки**: Система должна игнорировать дублирующиеся заголовки в строках 2 и 8-10.
- [x] **Отрицательные значения**: Система должна корректно обрабатывать отрицательные значения в столбцах начального остатка, прихода и расхода, понимая их как корректировки, возвраты или оприходование излишков.
- [x] **Некорректные/неполные данные**: Система должна быть устойчива к некорректным или неполным строкам/заголовкам и файлам.
- [x] **Коррекции, возвраты, инвентаризации:** Парсер должен корректно обрабатывать отрицательные/нулевые значения, а также строки без явных партии/номенклатуры.

### 5. Особенности категорий товаров
- [x] **Коррекции**: Система должна распознавать и корректно обрабатывать специальные документы корректировки, учитывая их влияние на точность анализа убытков.
- [x] **Разливное пиво и напитки**: Система должна учитывать фильтрацию по базовой единице "л дм3" и высокую точность учета (до тысячных долей).
- [x] **Весовые товары**: Система должна обрабатывать весовые товары с высокой точностью учета (до тысячных и десятитысячных долей), учитывая специфику округления.
- [x] **Рыбная продукция**: Система должна учитывать специализированные склады и особые условия хранения.
- [x] **Весовые товары и рыба:** Парсер должен обрабатывать высокоточные значения, отдельные шаблоны оформления остатков и движений (размер партии — дробный).

### Уточнения для спецификации:
- [x] “Парсер гарантирует сохранение FIFO и движений по партиям ровно как они получены в отчёте 1С, без повторного пересчитывания или корректировки. Основной принцип — любой расход или коррекция всегда привязаны к партии с `batch_code`+`batch_date`, созданной приходным документом.”
- [x] “Все технические или некорректные строки отбрасываются/логируются; при невозможности восстановить контекст строка исключается с пояснением причины.”
- [x] “Любые попытки автоматического углубленного анализа партий (реализация FIFO либо перекиньте остатки) категорически запрещены. Ваш единственный источник истины — структура выгруженная из 1С-отчёта.”

### 6. Выходные данные
- [x] Функция должна возвращать плоскую таблицу данных.
- [x] Каждая строка должна содержать информацию о товаре (наименование, тип, единица измерения).
- [x] Каждая строка должна содержать информацию об операции/документе.
- [x] Каждая строка должна содержать дату операции в нормализованном формате `DD.MM.YYYY HH:MM:SS`.
- [x] Числовые значения должны быть представлены с высокой точностью (до трех знаков после запятой).
- [x] Все атрибуты из иерархии должны быть сохранены в унифицированном формате.
- [x] Отсутствие пустых `batch_code` в выходных данных.
- [x] Корректные числовые значения (не `null` или некорректные типы).
- [x] Возможность вывода ошибок/логов по проблемным строкам для аудита.

### 7. Критерии успеха
- [x] Пользователи могут загрузить Excel-файл с иерархической структурой и получить плоскую таблицу данных за менее чем 30 секунд.
- [x] Система корректно преобразует иерархические структуры, сохраняя все уровни в 100% случаев.
- [x] Пользователи могут обработать файл объёмом до 50МБ с иерархическими данными без ошибок.
- [x] Не менее 95% пользователей успешно завершают основной сценарий преобразования иерархии в плоские данные с первого раза.
- [x] Система поддерживает обработку как минимум 3 различных типов иерархических структур Excel-отчётов.
- [x] Система корректно обрабатывает весовые товары с высокой точностью чисел (до трех знаков после запятой) в 100% случаев.
- [x] Система корректно сопоставляет разрозненные заголовки, распределенные по строкам, в 100% случаев.
- [x] Система игнорирует все технические/пустые строки без потерь полезных данных.
- [x] Система корректно обрабатывает колонки, содержащие `null` значения, в 100% случаев.
- [x] Система генерирует корректный отчет об ошибках и проблемных строках в 100% случаев.

### 8. Критерии качества
- [x] Выходные данные должны быть полностью валидными по типам и структуре.
- [x] Все числовые значения должны сохранять свою точность (особенно весовые товары).
- [x] Все текстовые значения должны корректно обрабатывать кириллицу.
- [x] Система должна быть устойчива к некорректным или неполным входным данным.
- [x] Время обработки не должно превышать 30 секунд для файлов до 50МБ.

### 9. Пользовательские сценарии
- [x] Пользователь может загрузить Excel-файл с иерархической структурой данных и получить плоскую таблицу с унифицированными строками, содержащими все уровни иерархии в одном ряду.
- [x] Система преобразует иерархию в плоскую структуру с сохранением всех атрибутов (товар, операция, документ, дата_операции, тип_операции, количество, остаток).
- [x] Система сохраняет контекстные связи между всеми уровнями в результирующей плоской таблице.
- [x] Система адаптируется к структуре и преобразует её в плоские данные.
- [x] Система генерирует отчет об ошибках и проблемным строкам при необходимости.

## Приемочные тесты по файлам

### 1. [`/home/user909/shield_ai_v2/data/input/13.10.25-13.10.25 только весовые товары.xlsx`](/home/user909/shield_ai_v2/data/input/13.10.25-13.10.25 только весовые товары.xlsx)
- [x] **Ожидаемый результат:** Корректное преобразование в flat-формат с сохранением высокой точности числовых значений (до тысячных и десятитысячных долей) для всех весовых товаров. Извлечение всех движений и остатков.
- [x] **Критерии приемки:**
    - [x] Парсер успешно обрабатывает файл без ошибок, относящихся к структуре или восстановлению контекста.
    - [ ] Количество строк в flat-формате соответствует ожидаемому (указать конкретное число после тестового прогона).
    - [x] Для каждой строки движения `batch_code` и `batch_date` корректно восстановлены из приходного документа или предыдущего валидного контекста.
    - [x] Все значения в колонках "Количество", "Приход", "Расход", "Начальный остаток", "Конечный остаток" имеют точность не менее 3-4 знаков после запятой, без потери данных.
    - [x] Отсутствие пустых полей `product`, `batch_code`, `batch_date`, `doc_type`, `doc_date` в выходных данных для каждой строки движения.
    - [x] Корректное определение всех движений и остатков, включая дробные значения партий.
    - [x] Лог ошибок пуст или содержит только ожидаемые предупреждения о некорректных структурах, не подлежащих восстановлению.
    - [x] Пример: Проверить корректность извлечения данных для "Весовой товар А" с дробным количеством 123.4567, убедиться, что его `batch_code` и `batch_date` соответствуют приходу.

### 2. [`/home/user909/shield_ai_v2/data/input/13.10.25-13.10.25 Полный все склады с коррекцией.xlsx`](/home/user909/shield_ai_v2/data/input/13.10.25-13.10.25 Полный все склады с коррекцией.xlsx)
- [x] **Ожидаемый результат:** Корректное преобразование в flat-формат с учетом всех складов и обработкой корректировок, возвратов и инвентаризаций. Все строки движения должны иметь восстановленный контекст (склад, товар, партия).
- [x] **Критерии приемки:**
    - [x] Парсер успешно обрабатывает файл без ошибок, относящихся к структуре или восстановлению контекста.
    - [ ] Количество строк в flat-формате соответствует ожидаемому (указать конкретное число после тестового прогона).
    - [x] Для каждой строки движения `batch_code` и `batch_date` корректно восстановлены из приходного документа или предыдущего валидного контекста.
    - [x] Корректное распознавание и обработка строк, содержащих отрицательные или нулевые значения в полях "Приход", "Расход", "Начальный остаток", "Конечный остаток", без изменения их значения или интерпретации (только flat-конвертация).
    - [x] Восстановление контекста (склад, товар, партия, дата, тип документа) для строк без явных данных, используя предыдущий валидный блок.
    - [x] Правильное агрегирование данных по различным складам (т.е. сохранение информации о складе для каждой строки).
    - [x] Все колонки типизированы согласно требованиям, без `null` значений там, где они должны быть восстановлены.
    - [x] Лог ошибок пуст или содержит только ожидаемые предупреждения о невосстанавливаемых строках.
    - [x] Пример: Проверить строку с отрицательным значением "Расход" для "Товар Б" и корректность восстановления склада "Склад X" и соответствующего `batch_code`/`batch_date` партии, к которой относится расход.

### 3. [`/home/user909/shield_ai_v2/data/input/13.10.2025 все СКЛАДЫ Разливное пиво.xlsx`](/home/user909/shield_ai_v2/data/input/13.10.2025 все СКЛАДЫ Разливное пиво.xlsx)
- [x] **Ожидаемый результат:** Корректное преобразование в flat-формат с учетом специфики разливного пива (базовая единица "л дм3") и высокой точности учета.
- [x] **Критерии приемки:**
    - [x] Парсер успешно обрабатывает файл без ошибок, относящихся к структуре или восстановлению контекста.
    - [ ] Количество строк в flat-формате соответствует ожидаемому (указать конкретное число после тестового прогона).
    - [x] Для каждой строки движения `batch_code` и `batch_date` корректно восстановлены из приходного документа или предыдущего валидного контекста.
    - [x] Все значения в колонках "Количество" и "Остаток" для разливного пива имеют точность не менее тысячных долей (например, 0.750).
    - [x] Корректное определение "л дм3" как единицы измерения в соответствующей колонке.
    - [x] Правильная обработка фильтрации по группе товаров "Разливные напитки" (т.е. парсер должен уметь распознавать эту категорию).
    - [x] Лог ошибок пуст или содержит только ожидаемые предупреждения.
    - [x] Пример: Проверить строку с "Пиво Светлое" и объемом 0.750 л дм3, убедиться, что `batch_code` и `batch_date` соответствуют приходу.

### 4. [`/home/user909/shield_ai_v2/data/input/горбуша.xlsx`](/home/user909/shield_ai_v2/data/input/горбуша.xlsx)
- [x] **Ожидаемый результат:** Корректное преобразование в flat-формат с учетом специфики рыбной продукции ("ГОРБУША Х/К") и специализированных складов ("Монетка рыба (Рыба Дачная )"), обработка только ненулевых движений.
- [x] **Критерии приемки:**
    - [x] Парсер успешно обрабатывает файл без ошибок, относящихся к структуре или восстановлению контекста.
    - [ ] Количество строк в flat-формате соответствует ожидаемому (указать конкретное число после тестового прогона).
    - [x] Для каждой строки движения `batch_code` и `batch_date` корректно восстановлены из приходного документа или предыдущего валидного контекста.
    - [x] Корректное определение товара "ГОРБУША Х/К" и его специфических атрибутов (например, "рыба").
    - [x] Правильная обработка фильтрации по складу "Монетка рыба (Рыба Дачная )" (т.е. парсер должен уметь распознавать этот склад).
    - [x] Обработка только ненулевых движений, игнорирование пустых строк или строк с нулевыми движениями.
    - [x] Лог ошибок пуст или содержит только ожидаемые предупреждения.
    - [x] Пример: Проверить, что в выходных данных отсутствуют строки с нулевыми движениями для горбуши, и что `batch_code`/`batch_date` для всех движений корректны.

### 5. [`/home/user909/shield_ai_v2/data/input/СКУМБРИЯ.xlsx`](/home/user909/shield_ai_v2/data/input/СКУМБРИЯ.xlsx)
- [x] **Ожидаемый результат:** Корректное преобразование в flat-формат с учетом специфики рыбной продукции ("СКУМБРИЯ Х/К") и специализированных складов ("Монетка рыба (Рыба Дачная )"), обработка только ненулевых движений.
- [x] **Критерии приемки:**
    - [x] Парсер успешно обрабатывает файл без ошибок, относящихся к структуре или восстановлению контекста.
    - [ ] Количество строк в flat-формате соответствует ожидаемому (указать конкретное число после тестового прогона).
    - [x] Для каждой строки движения `batch_code` и `batch_date` корректно восстановлены из приходного документа или предыдущего валидного контекста.
    - [x] Корректное определение товара "СКУМБРИЯ Х/К" и его специфических атрибутов (например, "рыба").
    - [x] Правильная обработка фильтрации по складу "Монетка рыба (Рыба Дачная )" (т.е. парсер должен уметь распознавать этот склад).
    - [x] Обработка только ненулевых движений, игнорирование пустых строк или строк с нулевыми движениями.
    - [x] Лог ошибок пуст или содержит только ожидаемые предупреждения.
    - [x] Пример: Проверить, что в выходных данных отсутствуют строки с нулевыми движениями для скумбрии, и что `batch_code`/`batch_date` для всех движений корректны.