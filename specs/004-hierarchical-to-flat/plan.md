# План реализации: Преобразование иерархических Excel-отчётов в плоские данные

**Ветка**: `004-hierarchical-to-flat` | **Дата**: 2025-11-15 | **Спецификация**: `specs/004-hierarchical-to-flat/spec.md`

**Ввод**: Спецификация функции из `/specs/004-hierarchical-to-flat/spec.md`

**Примечание**: Этот шаблон заполняется командой `/speckit.plan`. См. `.specify/templates/commands/plan.md` для рабочего процесса выполнения.

## Резюме

Основное требование — разработать парсер, который преобразует иерархические Excel-отчеты "Ведомость по партиям номенклатуры" в плоскую структуру данных (flat-таблицу). Парсер должен точно извлекать данные о движениях товаров, сохраняя контекст (склад, товар, партия, документ) для каждой строки, и строго следовать порядку движений из исходного отчета, не применяя вторичную логику (например, пересчет FIFO).

## Технический контекст

**Язык/Версия**: Python 3.12
**Основные зависимости**: `openpyxl` и `pandas` (указанные в `requirements.txt` для работы с Excel-файлами).
**Хранилище**: Выходные данные - плоские структуры (например, список словарей), которые могут быть переданы в другие компоненты (например, экспортеры в JSON, SQLite).
**Тестирование**: pytest. Интеграционные тесты должны включать сверку с "golden master" (эталонными, рассчитанными вручную итогами). При каждом изменении парсера обязателен запуск регрессионных тестов на утвержденном наборе старых эталонов.
**Целевая платформа**: Сервер Linux (WSL 2)
**Тип проекта**: Одиночный проект (монолитная структура в `src/shield_ai`)
**Цели производительности**: Обработка файла объёмом до 50МБ менее чем за 30 секунд.
**Ограничения**: Код должен быть синхронным. Запрещена любая вторичная логика агрегации или пересчета партий. Точность числовых данных (до 3-4 знаков) должна быть сохранена.
**Масштаб/Объем**: Обработка файлов с десятками тысяч строк.
**Логирование**: Подробное логирование с использованием стандартного логгера Python для аудита и отладки, включая информацию о процессе парсинга, обнаруженных ошибках и исключениях. Логирование должно включать координаты строк с ошибками и контекст для последующего анализа.

## Проверка конституции

*ПРОХОД: Должен пройти до исследования фазы 0. Повторная проверка после проектирования фазы 1.*

- **[ПРОЙДЕНО]** **Наличие `spec.md` и `plan.md`**: Задача инициирована с необходимыми артефактами.
- **[ПРОЙДЕНО]** **Следование `plan.md`**: План не будет изменяться самовольно.
- **[ПРОЙДЕНО]** **Сверка с `spec.md`**: Все результаты будут сверяться со спецификацией.
- **[ПРОЙДЕНО]** **Синхронный код**: Спецификация явно запрещает сложную асинхронную логику и пересчеты, что соответствует требованию писать синхронный код. `async/await` использоваться не будет.
- **[ПРОЙДЕНО]** **Чистая архитектура**: Задача по созданию парсера хорошо вписывается в `infrastructure` слой, отделяя логику извлечения данных от доменной логики.
- **[ПРОЙДЕНО]** **TDD (Test-Driven Development)**: Спецификация содержит четкие приемочные тесты для каждого типа входных файлов, что является основой для TDD.

## Структура проекта

### Документация (эта функция)

```text
specs/004-hierarchical-to-flat/
├── plan.md              # Этот файл (вывод команды /speckit.plan)
├── research.md          # Вывод фазы 0 (команда /speckit.plan)
├── data-model.md        # Вывод фазы 1 (команда /speckit.plan)
├── quickstart.md        # Вывод фазы 1 (команда /speckit.plan)
├── contracts/           # Вывод фазы 1 (команда /speckit.plan)
└── tasks.md             # Вывод фазы 2 (команда /speckit.tasks - НЕ создается командой /speckit.plan)
```

### Исходный код (корень репозитория)

```text
# Вариант 1: Один проект (ПО УМОЛЧАНИЮ)
src/shield_ai/
├── infrastructure/
│   ├── parsers/
│   │   ├── hierarchical_excel_parser.py  # Новый модуль парсера
│   │   └── dto/                          # Data Transfer Objects для flat-структуры
│   └── ...
└── ...

tests/
├── integration/
│   └── test_hierarchical_excel_parser.py # Интеграционные тесты
└── unit/
    └── parsers/
        └── test_hierarchical_excel_parser_units.py # Юнит-тесты для отдельных компонентов парсера
```

**Решение по структуре**: Используется существующая структура единого проекта. Новый парсер будет размещен в `src/shield_ai/infrastructure/parsers/`, так как он отвечает за преобразование данных из внешнего источника (Excel) во внутреннее представление. Тесты будут добавлены в соответствующие директории `tests/`.

## Роли и Ответственности

-   **Владелец продукта (Product Owner):** Отвечает за бизнес-требования в `spec.md`.
-   **Разработчик (Developer):** Отвечает за реализацию, написание юнит-тестов и следование TDD.
-   **Тест-инженер (QA Engineer):** Является владельцем "golden master" эталонов, отвечает за создание и поддержку регрессионных и интеграционных тест-кейсов.
-   **Аналитик (Analyst):** Консультирует по логике расчета метрик и помогает в подготовке "golden master".

## Обновление Streamlit-интерфейса

После обновления спецификации, моделей данных и парсера необходимо **обновить существующий Streamlit-интерфейс**:
-   Привести UI к новым полям и структурам (`FlatRecord`, включая `metadata`).
-   Включить раздел для интерактивного просмотра сообщений об ошибках, с возможностью фильтрации и экспорта.
-   Проверить работоспособность загрузки файлов с типовыми отчетами и файлами для регресс-тестов.
-   Реализовать новые требования по визуализации результатов и аудиту flat-отчёта (например, отображение "индикатора консистентности").

## CLI интерфейс

В рамках реализации функциональности преобразования иерархических Excel-отчётов в плоские данные, необходимо реализовать CLI-интерфейс с следующими возможностями:

### 1. Функциональность пакетного парсинга
CLI интерфейс должен предоставлять команду для пакетной обработки Excel-файлов из указанной директории. Команда должна:
- Принимать путь к директории с входными Excel-файлами
- Обрабатывать все файлы с расширением `.xlsx` в указанной директории
- Генерировать плоские данные в соответствии с описанными выше требованиями
- Сохранять результаты в указанную выходную директорию в формате JSON или CSV

### 2. Выгрузка ошибок
CLI команда должна включать опцию для генерации и выгрузки всех ошибок, обнаруженных в процессе парсинга, в отдельный файл. Файл ошибок должен содержать:
- Номер строки в исходном файле
- Тип ошибки
- Описание ошибки
- Имя исходного файла
- Контекст ошибки (значения в строке)

### 3. Агрегированный summary
CLI интерфейс должен предоставлять возможность генерации агрегированного отчета по результатам batch-обработки, включающего:
- Общее количество обработанных файлов
- Общее количество обработанных строк
- Количество успешно обработанных строк
- Количество строк с ошибками
- Процент корректности обработки
- Статистику по типам ошибок
- Время начала и завершения обработки
- Общее время выполнения

### 4. Логирование
CLI команда должна обеспечивать детальное логирование процесса обработки, включая:
- Старт и завершение обработки файлов
- Информацию о каждом обрабатываемом файле
- Обнаруженные ошибки и исключения
- Прогресс обработки (например, количество обработанных файлов из общего числа)

## Отслеживание сложности

> **Заполнить ТОЛЬКО если проверка конституции имеет нарушения, которые должны быть оправданы**

| Нарушение | Почему необходимо | Более простая альтернатива отклонена, потому что |
|-----------|------------|-------------------------------------|
| (Нет нарушений) | - | - |
