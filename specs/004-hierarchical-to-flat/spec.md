# Спецификация функции: Преобразование иерархических Excel-отчётов в плоские данные

**Функциональная ветка**: `04-hierarchical-to-flat`
**Создано**: 2025-11-15
**Статус**: В работе

## 1. Входные данные

Функция принимает на вход Excel-файлы со сложной иерархической структурой, отражающие отчет "Ведомость по партиям номенклатуры". Примеры файлов:
- `data/input/13.10.25-13.10.25 Полный все склады с коррекцией.xlsx`
- `data/input/13.10.2025 все СКЛАДЫ Разливное пиво.xlsx`
- `data/input/горбуша.xlsx`
- `data/input/СКУМБРИЯ.xlsx`

## 2. Общая иерархическая структура и ключевые особенности

Все проанализированные файлы имеют одинаковую иерархическую структуру:

1. **Склад**: Верхний уровень иерархии, представляет собой место хранения товаров.
2.  **Номенклатура (Товар)**: Группа конкретных товаров/продуктов.
3.  **Документ движения**: Транзакция, вызвавшая изменение в остатках (поступление, расход, корректировка и т.д.).
4. **Партия.Дата прихода**: Конкретная партия товара с указанием даты поступления.
 
**Определение партии**:
Партия — это уникальный приход товара, оформленный отдельным документом движения с уникальной датой и временем создания, связанным с документом движения. Как правило, партия создаётся приходным документом и отражается в отчёте 1С как результат поступления или оприходования товара. Однако, в зависимости от выбранного периода отчёта или настройки фильтров, выгрузке может встретиться партия, по которой отсутствует приходная накладная внутри этого отчётного периода (например, партия уже была принята на склад ранее, до начала анализируемого диапазона). В таком случае партия появляется только по остаткам на начало или по движениям, без явного документа прихода в этом выгрузке.

**Ключевые особенности структуры (для всех разобранных файлов):**
- Под номенклатурой (товаром) действительно идут блоки документов, а внутри документа — строки движения партии.
- Каждая строка движения содержит сведения о списании или поступлении по определённой партии.
- **Партия создаётся только приходным документом.** Партия — это уникальное сочетание товара и даты (времени) ее приёмки, иногда с номером или внутренним идентификатором. Если `batch_code` пропущен, он должен быть явно восстановлен по контексту из последнего валидного.
- Все последующие операции (расходы, корректировки, возвраты) только "тратят" или "корректируют" уже созданную ранее партию.
- Вся логика обработки движений производится 1С, и ваш парсер не должен по-своему рассчитывать/размещать движения внутри партий: строки идут РОВНО в порядке, в котором возвращены в выгрузке отчёта, с сохранением всех `batch_code`/`batch_date`/`doc_type`.

## 3. Уникальные иерархические уровни и вариации

### 3.1. Файл "13.10.25-13.10.25 Полный все склады с коррекцией.xlsx"
- Содержит все склады без фильтрации.
- Включает корректировки, что отражено в названии файла.
- Не имеет дополнительных фильтров.

### 3.2. Файл "13.10.2025 все СКЛАДЫ Разливное пиво.xlsx"
- Дополнительный уровень фильтрации: "Номенклатура.Базовая единица по классификатору Равно 'л дм3'".
- Включает группу товаров "Разливные напитки" (помимо разливного пива).
- Имеет более широкую категоризацию товаров.

### 3.3. Файлы "горбуша.xlsx" и "СКУМБРИЯ.xlsx"
- Имеют фильтр по конкретному товару: "Номенклатура Равно 'ГОРБУША Х/К'" или "СКУМБРИЯ Х/К'".
- Включают фильтр по конкретному складу: "Склад Равно 'Монетка рыба (Рыба Дачная )'".
- Отображают только ненулевые движения.
- Специализированный склад для хранения рыбной продукции.

**Примечание:** При дальнейшем увеличении числа категорий товаров, их особенности (ключевые слова, структура) рекомендуется вынести в отдельный конфигурационный файл (например, YAML) для упрощения расширения.

## 4. Типы данных и форматы

Все файлы используют одинаковую структуру столбцов:

-   **A**: Склад/Номенклатура/Документ движения/Партия - текстовые данные.
-   **B**: Пустой столбец (вспомогательный).
-   **C**: Параметры отчета, фильтры, даты - смешанные типы.
-   **D**: Пустой столбец (вспомогательный).
-   **E**: Начальный остаток (для файлов с разливным пивом).
-   **F**: Начальный остаток количества.
-   **G**: Приход количества.
-   **H**: Расход количества.

Все числовые данные представлены в формате с плавающей точкой с высокой точностью (до 4 знаков после запятой), что важно для учета весовых товаров и напитков. Все числовые значения должны быть округлены до 4 знаков после запятой по правилам математического округления (банковское округление: при равенстве отклонений от двух соседних чисел округление производится к ближайшему четному числу).

## 5. Итоговые требования к парсеру/спецификации

### 5.1. Контекст
- Всегда "тянуть" вниз актуальный контекст товара, документа, партии (дата и номер приема).
- Если какая-либо из сущностей пропущена в строке движения, брать её из предыдущего блока, либо логировать как ошибку и пропускать строку, если восстановление невозможно.

### 5.2. Flat-структура строки
- Каждая строка движения (output-flat) содержит: `warehouse`, `group`, `product`, `batch_code`, `batch_date`, `doc_type`, `doc_date`, `qty_begin`, `qty_in`, `qty_out`, `qty_end`, `unit`, `comment`.
- `batch_code` & `batch_date` тянутся только от прихода (создания партии), расход — только списывает из существующей партии, все движения (в т.ч. возвраты/коррекции) указывают на уже существующую партию в отчёте.

### 5.3. Признаки, шаблоны, автоматическое определение
- Парсер обязан использовать паттерны для отделения заголовков, итогов, разделительных строк.
- Проверять разные шаблоны дат (с/без времени).
- Автоматически определять специфику структуры (рыба, весовые, вода, "разливное"), если структура отличается от базовой, — по фильтрам, названиям, уникальным словам.

### 5.4. Запрет вторичной логики
- Не делать никакую вторичную логику партий, FIFO, агрегацию остатков — только flat-конвертация!
- Если последовательность движения в отчёте порвана или `batch_code`/`dates` неочевидны, оставлять строку с `error flag/log`.
- Парсер гарантирует сохранение движений по партиям ровно как они получены в отчёте 1С, без повторного пересчитывания или корректировки. Основной принцип — любой расход или коррекция всегда привязаны к партии с `batch_code`+`batch_date`, созданной приходным документом.
- Все технические или некорректные строки отбрасываются/логируются; при невозможности восстановить контекст строка исключается с пояснением причины.
- Любые попытки автоматического углубленного анализа партий (реализация FIFO либо перекиньте остатки) категорически запрещены. Ваш единственный источник истины — структура выгруженная из 1С-отчёта.

**FIFO**
Порядок списания остатков по FIFO отображается в самом отчёте 1С. Парсер не должен выполнять собственных расчётов FIFO: он только отражает порядок списания FIFO из 1С-отчета, а не выполняет собственные расчеты или переоценки. Любая логика связанных партий, распределения между ними (FIFO) должна соответствовать структуре выгрузки.

### 5.5. Автоматическое определение структуры входного файла
- Если файл — "рыба" или "разливное" — автоопределение признаков (например, по первым строкам, ключевым словам или сочетанию столбцов/фильтров).

## 6. Обработка ошибок и edge-case
- Отдельно логировать:
    - Строки с пропущенным `batch_code`/`batch_date`, которые не удалось восстановить
    - Все некорректные структуры (двойной заголовок, строка "итого", строки с разрывом контекста)
    - Строки, в которых нарушен expected порядок (например, расход/коррекция идет до первого прихода партии)
    - Строки с невосстановимым отсутствием `batch_date` или `doc_date` (после попытки взять из контекста). Такие строки должны быть отброшены и занесены в лог ошибок.

### 6.1. Граничные случаи
- Пустые строки/ячейки: Присутствуют в начале каждого файла (строки 1-3 и 6-7), встречаются в середине данных как разделители. Ячейки с нулевыми значениями могут быть как пустыми, так и содержать 0.
- Смешанные типы в столбце A: В столбце A объединены разные уровни иерархии (Склад, Номенклатура, Документ, Партия). Текстовые строки чередуются с датами и названиями документов. Требуется логика для определения типа записи по контексту.
- Дублирующиеся заголовки: Заголовки повторяются в строках 2 и 8-10, что может вызвать путаницу при парсинге. Необходима предварительная обработка для идентификации настоящих данных.
- Отрицательные значения: Присутствуют в столбцах F (начальный остаток), G (приход), H (расход). Отрицательные значения могут указывать на корректировки, возвраты или оприходование излишков. Особенно заметны в файле с коррекциями.
- Перенос партии (пересортица, явно внесённая корректировка партии в отчёте): Требуется логировать, но не мешать расчёту.

## 7. Предложения по унификации парсинга

### 7.1. Механизм "контекстного стека"
- Для каждой строки движения значения всех вышестоящих уровней (склад, товар, партия, документ) ДОЛЖНЫ "тянуться вниз" до тех пор, пока не встретится новая их явная установка.
- **Логика прогонки контекста**: "На каждом уровне иерархии парсер ДОЛЖЕН тянуть актуальное значение вверх по дереву (от последней валидной строки), если оно не задано явно."
### 7.2. Структура выходных Flat-записей (FlatRecord)

Каждая строка движения (output-flat) содержит следующие поля:

| Поле | Тип | Описание |
|------|-----|----------|
| `warehouse` | string | Склад, на котором произошла транзакция |
| `group` | string | Товарная группа |
| `product` | string | Наименование конкретного товара |
| `batch_code` | string | Уникальный идентификатор партии. Создается только приходным документом |
| `batch_date` | datetime | Дата прихода партии. Важно для FIFO и отслеживания срока годности |
| `doc_type` | string | Тип документа движения (например, 'Поступление', 'Реализация') |
| `doc_date` | datetime | Дата документа движения. Должна быть с таймзоной для избежания несостыковок |
| `qty_begin` | Decimal | Начальное количество до транзакции |
| `qty_in` | Decimal | Количество поступления |
| `qty_out` | Decimal | Количество расхода |
| `qty_end` | Decimal | Конечное количество после транзакции |
| `unit` | string | Единица измерения (например, 'кг', 'шт') |
| `comment` | string (optional) | Необязательный комментарий к записи |
| `metadata` | Dict (optional) | Служебные метаданные для будущего расширения |


### 7.3. Требования к логам и обработке ошибок

- **Логи ошибок**: "Все некорректные или пропущенные значения ДОЛЖНЫ быть записаны в отдельный лог с координатой исходной строки и причиной отбраковки."
- Логирование ДОЛЖНО включать: "context lost", "wrong parse", "duplicate header", "missing batch_code/batch_date" с указанием координат исходной строки для отладки и аудита.

### 7.4. Контроль консистентности Batch Code и Batch Date

- Если парсится `batch_code`, но `batch_date` отсутствует, парсер ДОЛЖЕН либо логировать это как ошибку, либо брать `batch_date` из контекста (обязательное правило для парсера).

### 7.5. Автоматическое определение структуры входного файла
- Если входной файл является "рыбой" или "разливным", система ДОЛЖНА автоматически определять признаки (например, по первым строкам, ключевым словам или сочетанию столбцов/фильтров).

---

## 8. Требования к точности и округлению

Все числовые значения в результирующих flat-записях должны быть представлены с точностью до 4 знаков после запятой. При этом необходимо использовать математическое округление (банковское округление): при равенстве отклонений от двух соседних чисел округление производится к ближайшему четному числу.

## 9.1 Требования для корректного расчёта усушки (Shrinkage Accounting)

1.  **Ограничения периода расчёта усушки:**
    *   Корректный расчёт усушки возможен только для интервала между двумя последовательными инвентаризациями: начальная инвентаризация задаёт `qty_begin`, финальная — `qty_end`. Если инвентаризация была один раз — расчёт ведётся от неё до конца периода.
2. **Формула расчёта усушки для каждой партии:**
    *   Для каждой уникальной партии (`warehouse`, `product`, `batch_code`, `batch_date`) усушка вычисляется за период между инвентаризациями формулой:
        $$
        shrinkage = qty\_in + qty\_begin - qty\_out - qty\_end
        $$
        где `qty_end` — остаток по партии после конечной инвентаризации.
3.  **Соответствие исходной логике списания:**
    *   Логика списания партий уже реализована при формировании движений в 1С-отчёте. Flat-парсер ничего не 'размешивает' внутри одной партии — а просто фиксирует движения между инвентаризациями и фиксирует фактическую усушку, выявленную физической ревизией (инвентаризацией), без какой-либо дополнительной обработки или пересчёта.
4. **Работа с "минусом" и техническим разбросом:**
    *   Если между инвентаризациями по партии есть отрицательные остатки, пересортицы или другие отклонения, они не исправляются парсером — они отображаются в отчёте. Только финальный `qty_end` после инвентаризации определяет, сколько реально осталось, то есть сколько усушено.
5.  **Контроль контекста:**
    *   Все строки без явно восстановленного `batch_code` (или других обязательных идентификаторов партии) — выбрасываются или выносятся в error-log и в расчетах не участвуют.
6.  **Требование к тестам и валидации:**
    *   Результаты автоматического расчёта усушки на типовых отчетах сверяются с результатами ручной сверки на примерах с заранее известной усушкой ('golden master' для партии).
7.  **Инвентаризация как маркер пограничного остатка:**
    *   Инвентаризация как в начале, так и в конце периода 'обнуляет' все технические расхождения и определяет точку отсчёта для расчёта усушки — аналитика и E2E тесты должны базироваться на этом правиле.
8.  **В вывод flat-отчёта для анализа усушки обязательно включать строки инвентаризации как отдельные виды движений, не смешивать их с обычным расходом/приходом.

**Финальный акцент:**
- Парсер должен делать только точное плоское отображение факта движения из 1С-отчёта согласно видимой последовательности, без какой-либо логики по пересчёту FIFO, агрегации, соединения или восстановления остатков партий. Вся обработка данных должна быть синхронной без дополнительной логики.

---

## 10. Требования к CLI интерфейсу

### 10.1. Функциональность пакетного парсинга

CLI интерфейс должен предоставлять команду для пакетной обработки Excel-файлов из указанной директории. Команда должна:

- Принимать путь к директории с входными Excel-файлами
- Обрабатывать все файлы с расширением `.xlsx` в указанной директории
- Генерировать плоские данные в соответствии с описанными выше требованиями
- Сохранять результаты в указанную выходную директорию в формате JSON или CSV

### 10.2. Выгрузка ошибок

CLI команда должна включать опцию для генерации и выгрузки всех ошибок, обнаруженных в процессе парсинга, в отдельный файл. Файл ошибок должен содержать:

- Номер строки в исходном файле
- Тип ошибки
- Описание ошибки
- Имя исходного файла
- Контекст ошибки (значения в строке)

### 10.3. Агрегированный summary

CLI интерфейс должен предоставлять возможность генерации агрегированного отчета по результатам batch-обработки, включающего:

- Общее количество обработанных файлов
- Общее количество обработанных строк
- Количество успешно обработанных строк
- Количество строк с ошибками
- Процент корректности обработки
- Статистику по типам ошибок
- Время начала и завершения обработки
- Общее время выполнения

### 10.4. Логирование

CLI команда должна обеспечивать детальное логирование процесса обработки, включая:

- Старт и завершение обработки файлов
- Информацию о каждом обрабатываемом файле
- Обнаруженные ошибки и исключения
- Прогресс обработки (например, количество обработанных файлов из общего числа)