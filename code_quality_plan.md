# План по повышению качества кода

## 1. Обзор ошибок

В ходе анализа кода были выявлены проблемы с помощью инструментов `isort`,
`black`, `ruff` и `mypy`. Ошибки можно разделить на две категории: те, что
исправляются автоматически, и те, что требуют ручного вмешательства.

## 2. Стратегия исправления

### 2.1. Автоматическое исправление

Следующие проблемы будут устранены автоматически с помощью скрипта:

- **`isort` (17 файлов):** Неправильная сортировка импортов.
- **`black` (20 файлов):** Нарушение стиля форматирования кода.
- **`ruff` (4 из 6 ошибок):**
  - `E402`: Импорт модуля находится не в начале файла.
  - `F401`: Модуль импортирован, но не используется.
  - `F841`: Локальной переменной присвоено значение, но она не используется.

**Команды для исправления:**

```bash
isort .
black .
ruff --fix .
```

### Скрипт для автоматизации (`scripts/auto_format.sh`)

Для удобства выполнения этих команд можно создать следующий скрипт:

```bash
#!/bin/bash

# Скрипт для автоматического форматирования и исправления ошибок качества кода

# 1. Сортировка импортов с помощью isort
echo "Running isort..."
isort .

# 2. Форматирование кода с помощью black
echo "Running black..."
black .

# 3. Автоматическое исправление ошибок с помощью ruff
echo "Running ruff --fix..."
ruff --fix .

echo "Auto-formatting complete."
```

### 2.2. Ручное исправление

Следующие ошибки требуют внимательного анализа и ручного исправления:

- **`mypy` (18 ошибок):**

  - **Проблемы с аннотациями типов:**
    - `Missing type parameters for generic type "Dict"`: Необходимо добавить
      конкретные типы, например, `Dict[str, Any]`.
    - `Need type annotation for "daily_sales"`: Добавить аннотацию типа для
      переменной.
    - `Returning Any from function declared to return "float"`: Проверить и
      исправить логику функции, чтобы она всегда возвращала `float`.
  - **Проблемы с заглушками типов (stubs):**
    - `Library stubs not installed for "scipy.optimize"` и `"pandas"`:
      Решается установкой `types-pandas` и `types-scipy` и добавлением их в
      `requirements.txt`.
  - **Архитектурные проблемы:**
    - `Cannot instantiate abstract class "ShrinkageStrategy"`: Это критическая
      ошибка. Необходимо найти место инстанцирования и использовать конкретную
      дочернюю реализацию этого класса.

- **`ruff` (2 оставшиеся ошибки):** Требуют индивидуального анализа после
  автоматического исправления.

### 2.3. Пошаговые инструкции для ручного исправления

#### `mypy`: Установка заглушек (stubs)

1. **Установите пакеты с типами:**

   ```bash
   pip install types-pandas types-scipy
   ```

1. **Обновите `requirements.txt`:**

   ```bash
   pip freeze > requirements.txt
   ```

   *Убедитесь, что новые пакеты добавлены.*

#### `mypy`: Исправление аннотаций типов

1. **`Missing type parameters for generic type "Dict"`:**
   - **Проблема:** `Dict` используется без указания типов ключа и значения.
   - **Решение:** Замените `Dict` на `Dict[key_type, value_type]`. Например,
     `Dict[str, int]`.
1. **`Need type annotation for "daily_sales"`:**
   - **Проблема:** Переменная `daily_sales` не имеет аннотации типа.
   - **Решение:** Добавьте тип, например: `daily_sales: List[float] = []`.
1. **`Returning Any from function declared to return "float"`:**
   - **Проблема:** Функция, которая должна возвращать `float`, может вернуть
     `Any`.
   - **Решение:** Внимательно проверьте все ветви `return` в функции.
     Убедитесь, что они возвращают `float` или приведите тип с помощью `cast`.

#### `mypy`: Архитектурная ошибка

- **`Cannot instantiate abstract class "ShrinkageStrategy"`:**
  - **Проблема:** Происходит попытка создать объект абстрактного класса
    `ShrinkageStrategy`, у которого есть нереализованные методы.
  - **Действия:**
    1. Найдите в коде место, где вызывается `ShrinkageStrategy(...)`.
    1. Определите, какая *конкретная* стратегия должна использоваться в этом
       контексте (например, `ExponentialShrinkageStrategy` или другая).
    1. Замените вызов на конструктор конкретного класса.
    1. Если конкретной реализации нет, ее необходимо создать.

## 3. Следующие шаги

1. Создать и выполнить скрипт для автоматического исправления.
1. Последовательно исправить ошибки `mypy`, начав с установки заглушек типов.
1. Проанализировать и исправить ошибку с инстанцированием абстрактного класса.
1. Исправить оставшиеся ошибки `ruff`.
1. Повторно запустить все проверки, чтобы убедиться в отсутствии ошибок.
